<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sign In</title>
<style>
    body{font-family:Arial;background:#f5f5f5;display:flex;justify-content:center;padding-top:50px;}
    .container{width:360px;background:#fff;padding:25px;border-radius:6px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
    label{margin-top:12px;display:block;font-weight:600}
    input,select{width:100%;padding:10px;margin-top:6px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box}
    .input-group{display:flex}
    #code{width:35%;margin-right:6px}
    .error{color:red;font-size:12px;display:none}
    .row{display:flex;justify-content:space-between;align-items:center;margin-top:15px}
    .remember-me{display:flex;align-items:center;font-size:14px}
    .remember-me input{width:auto;margin:0 5px 0 0}
    button{width:100%;padding:12px;margin-top:20px;background:#007bff;color:#fff;border:none;border-radius:4px;font-weight:bold;cursor:pointer}
    button:hover{background:#0056b3}
    .signup{text-align:center;margin-top:15px;font-size:14px}
    .signup a{color:#007bff;font-weight:600;text-decoration:none}
</style>
</head>
<body>

<div class="container">
    <h2>Sign In</h2>

    <label>Mobile</label>
    <div class="input-group">
        <select id="code"><option value="+91">+91</option></select>
        <input id="mobile" placeholder="Mobile Number">
    </div>
    <div class="error" id="mobileError"></div>

    <label>Password</label>
    <input id="password" type="password" placeholder="Password">
    <div id="passwordError" class="error"></div>

    <div class="row">
        <label class="remember-me">
            <input type="checkbox" id="rem"> Remember Me
        </label>
        <a href="#" onclick="forgot()" style="font-size:14px; color:#007bff; text-decoration:none;">Forgot password?</a>
    </div>

    <button onclick="login()">Login</button>

    <div class="signup">
        Create account?
        <a href="#" onclick="openSignup()">Sign Up</a>
    </div>
</div>



<script>
const API_BASE = "http://localhost:8080";

// 1. AUTO-LOGIN LOGIC: Runs as soon as page loads
window.onload = () => {
    // If a token exists in localStorage (Nth user returning), skip login
    if(localStorage.getItem('userToken')) {
        console.log("Token found, redirecting...");
        window.location.href = "dashboard.html";
    }
}

// 2. SIGN-IN LOGIC: Validates with Spring Boot Backend
function login() {
    // Combining country code with mobile number to match DB format
    const fullMobile = document.getElementById('code').value + document.getElementById('mobile').value;
    const pass = document.getElementById('password').value;
    const isRememberMe = document.getElementById('rem').checked;

    const payload = { 
        mobile: fullMobile, 
        password: pass 
    };

    fetch(`${API_BASE}/api/signin`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(res => {
        if (!res.ok) throw new Error("Invalid login");
        return res.json();
    })
    .then(user => {
        // If "Remember Me" is checked, store the token in the browser permanently
        if (isRememberMe) {
            localStorage.setItem('userToken', user.token);
        }
        
        alert("Login Successful! Welcome " + user.name);
        window.location.href = "dashboard.html"; 
    })
    .catch(err => {
        alert("Invalid mobile number or password");
        console.error(err);
    });
}

function openSignup() {
    window.location.href = "signup.html";
}

function forgot() {
    window.location.href = "sendotp.html";
}
</script>
</body>
</html>
